# 事件循环

## 机制

事件循环是 Node.js 处理非阻塞 I/O 操作的机制，尽管 JavaScript 是单线程处理的——当有可能的时候，它们会把操作转移到系统内核中去。目前大多数内核都是**多线程**的，它们可在**后台**处理多种操作。当其中的一个操作完成的时候，内核**通知 Node.js 将适合的回调函数添加到轮询队列中**等待时机执行。

当 Node.js 启动后，它会初始化事件轮询；处理已提供的输入脚本，它可能会调用一些异步的 API 函数调用，安排任务处理事件，或者调用 `process.nextTick()`，然后开始处理事件循环。

```
   ┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │<─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
```

每一个框内都是事件循环的一个阶段，每个阶段都有一个先进先出的队列来执行回调。当事件循环进入给定的阶段时，它将执行特定于该阶段的任何操作，然后在该阶段的队列中执行回调，直到队列用尽或最大回调数已执行。当该队列已用尽或达到回调限制，事件循环将移动到下一阶段。

由于每一个操作都可能计划执行更多的操作，并且在轮询阶段新事件由内核进行排队，因此在处理轮询事件时，轮询事件可以排队*（？个人理解：是可以在时间循环队列后插入新的事件）*

### 阶段概述

* 定时器：本阶段执行已经安排的 `setTimeout()` 和 `setInterval()` 的回调函数。
* 待定回调：执行延迟到下一个循环迭代的 I/O 回调。
* idle, prepare：仅系统内部使用。
* 轮询：检索新的 I/O 事件;执行与 I/O 相关的回调（几乎所有情况下，除了关闭的回调函数，它们由计时器和 `setImmediate()` 排定的之外），其余情况 node 将在此处阻塞。
* 检测：`setImmediate()` 回调函数在这里执行。
* 关闭的回调函数：一些准备关闭的回调函数，如：`socket.on('close', ...)`。

在每次运行的事件循环之间，Node.js 检查它是否在等待任何异步 I/O 或计时器，如果没有的话，则关闭。

## `process.nextTick()`

无论事件循环的当前阶段如何，都将在当前阶段的操作完成后处理 `nextTickQueue`。

```javascript
let b;

process.nextTick(() => {
  console.log(b);
  setImmediate(() => {
    console.log(b+1);
    process.nextTick(()=> {
      console.log(b+3);
    })
  })
  setImmediate(() => {
    console.log(b+2);
    process.nextTick(()=> {
      console.log(b+4);
    })
  })
})

b=0;
console.log(b-1)

/*
logs:
-1
0
1
2
3
4
*/
```



## 参考资料

https://nodejs.org/uk/docs/guides/event-loop-timers-and-nexttick/

