# http2

## 特点

* 与HTTP/1.1在[请求方法](https://zh.wikipedia.org/wiki/超文本传输协议#.E8.AF.B7.E6.B1.82.E6.96.B9.E6.B3.95)、[状态码](https://zh.wikipedia.org/wiki/超文本传输协议#状态码)乃至[URI](https://zh.wikipedia.org/wiki/URI)和绝大多数[HTTP头部](https://zh.wikipedia.org/w/index.php?title=HTTP头部&action=edit&redlink=1)字段等方面保持高度兼容性。
* 通过以下举措，减少 [网络延迟](https://zh.wikipedia.org/wiki/延迟_(工程学))，提高浏览器的页面加载速度：
  * 对[HTTP头字段](https://zh.wikipedia.org/wiki/HTTP头字段)进行[数据压缩](https://zh.wikipedia.org/wiki/数据压缩)(即HPACK算法)；
  * HTTP/2 服务端推送(Server Push)；
  * 请求[管线化](https://zh.wikipedia.org/wiki/HTTP管線化)；
  * 修复HTTP/1.0版本以来未修复的 [队头阻塞](https://zh.wikipedia.org/wiki/队头阻塞) 问题；
  * 对数据传输采用[多路复用](https://zh.wikipedia.org/wiki/多路复用)，让多个请求合并在同一 [TCP](https://zh.wikipedia.org/wiki/TCP) 连接内
* 支持现有的HTTP应用场景，包括桌面和移动设备浏览器，网络API，不同规格的[网络服务器](https://zh.wikipedia.org/wiki/网络服务器)和[正向代理](https://zh.wikipedia.org/w/index.php?title=正向代理&action=edit&redlink=1)、[反向代理](https://zh.wikipedia.org/wiki/反向代理)服务器软件，[防火墙](https://zh.wikipedia.org/wiki/防火墙)，CDN等。

## 二进制分帧

**帧：**HTTP/2 数据通信的最小单位消息：指 HTTP/2 中逻辑上的 HTTP 消息。例如请求和响应等，消息由一个或多个帧组成。

**流：**存在于连接中的一个虚拟通道。流可以承载双向消息，每个流都有一个唯一的整数ID。

HTTP/2 采用二进制格式传输数据，而非 HTTP 1.x 的文本格式，二进制协议解析起来更高效。 HTTP / 1 的请求和响应报文，都是由起始行，首部和实体正文（可选）组成，各部分之间以文本换行符分隔。HTTP/2 将请求和响应数据分割为更小的帧，并且它们采用二进制编码。

**HTTP/2 中，同域名下所有通信都在单个连接上完成，该连接可以承载任意数量的双向数据流。**每个数据流都以消息的形式发送，而消息又由一个或多个帧组成。多个帧之间可以乱序发送，根据帧首部的流标识可以重新组装。

## 多路复用

在 HTTP/2 中，有了二进制分帧之后，HTTP /2 不再依赖 TCP 链接去实现多流并行了，在 HTTP/2中：

- 同域名下所有通信都在单个连接上完成。
- 单个连接可以承载任意数量的双向数据流。
- 数据流以消息的形式发送，而消息又由一个或多个帧组成，多个帧之间可以乱序发送，因为根据帧首部的流标识可以重新组装。

这一特性，使性能有了极大提升：

- **同个域名只需要占用一个 TCP 连接**，消除了因多个 TCP 连接而带来的延时和内存消耗。
- 单个连接上可以并行交错的请求和响应，之间互不干扰。
- 在HTTP/2中，每个请求都可以带一个31bit的优先值，0表示最高优先级， 数值越大优先级越低。有了这个优先值，客户端和服务器就可以在处理不同的流时采取不同的策略，以最优的方式发送流、消息和帧。

## 头部压缩

为了减少每一次通信头部的资源消耗并提升性能， **HTTP/2对这些头部采取了压缩策略**：

- HTTP/2在客户端和服务器端使用“首部表”来跟踪和存储之前发送的键－值对，对于相同的数据，不再通过每次请求和响应发送；
- 首部表在HTTP/2的连接存续期内始终存在，由客户端和服务器共同渐进地更新;
- 每个新的首部键－值对要么被追加到当前表的末尾，要么替换表中之前的值。

若请求一发送了所有的头部字段，第二个请求则只需要发送差异数据，这样可以减少冗余数据，降低开销。

## HTTP2下管理CSS和JS

不再需要合并文件

我们现在优化的一个主要方向就是尽量的减少HTTP的请求数， 对我们工程中的代码，研发时分模块开发，上线时我们会把所有的代码进行压缩合并，合并成一个文件，这样不管多少模块，都请求一个文件，减少了HTTP的请求数。但是这样做有一个非常严重的问题：文件的缓存。当我们有100个模块时，有一个模块改了东西，按照之前的方式，整个文件浏览器都需要重新下载，不能被缓存。现在我们有了`HTTP/2`了，模块就可以单独的压缩上线，而不影响其他没有修改的模块。

有了HTTP2，应该拆分CSS和JS文件，只加载需要的文件。

## 参考资料

[https://zh.wikipedia.org/wiki/HTTP%E7%AE%A1%E7%B7%9A%E5%8C%96](https://zh.wikipedia.org/wiki/HTTP管線化)

https://zhuanlan.zhihu.com/p/26559480

https://segmentfault.com/a/1190000011172823